---
title: "Electronic Cigarette Use Among Youth in the United States (2011 - 2018)"
author: "Madison Stoms (ms5975), Rebecca Silva (rs4025), Robert Tumasian (rat2134), and Charlotte Fowler (crf2147)"
date: "December 2, 2019"
output: html_document
code_folding: "hide"
---
```{r setup, include=FALSE}
#loading packages
library(tidyverse)
library(srvyr)
library(viridis)
library(rvest)
library(httr)

#setting up document
knitr::opts_chunk$set(
	echo = FALSE,
	warning = FALSE,
	messge = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

#ggplot document wide settings
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

#loading e-cig and legislation data 
ecig_data = read.csv("ecig_dat.csv")  
legislation_data = 
  read_csv("CDC_State_ECigarette_Legislation_Youth_Access.csv") %>%
  as.data.frame() %>%
  janitor::clean_names() %>%
  select(c(year, location_abbr, location_desc, effective_date, geo_location)) %>%
  filter(year %in% c(2011:2018),
         !location_desc %in% c('American Samoa', 'Guam', 'Marshall Islands',
                               'Northern Mariana Islands', 'Palau', 'Puerto Rico',
                               'U.S. Virgin Islands')) %>%
  arrange(desc(year))

#loading e-cig prevalence data
url = "https://www.cdc.gov/pcd/issues/2019/18_0362.htm"

state_prev_xml = read_html(url)

state_prev = 
  (state_prev_xml %>% html_nodes(css = "table")) %>% 
  .[[1]] %>%
  html_table(fill = TRUE) #%>% 
 #rename (state = names(.)[1])

names(state_prev)[1] = "state"
names(state_prev)[2] = "ex1"
names(state_prev)[3] = "ex2"
names(state_prev)[4] = "ex3"
names(state_prev)[5] = "ex4"
names(state_prev)[6] = "ex5"
names(state_prev)[8] = "total_prev"
names(state_prev)[9] = "male_prev"
names(state_prev)[10] = "female_prev"

state_prev = state_prev %>% 
  select(state, total_prev, male_prev, female_prev) %>% 
  slice(3:n())  %>% 
  separate(state, into = c("state", "n"), "\\(") %>% 
  separate(total_prev, into = c("total_prev", "total_CI"), "\\(" ) %>% 
  separate(male_prev, into = c("male_prev", "male_CI"), "\\(" ) %>% 
  separate(female_prev, into = c("female_prev", "female_CI"), "\\(" ) %>% 
  select(state, total_prev, male_prev, female_prev)
```

## Motivation
Electronic cigarette (e-cigarette) use has become a growing public health concern. As of October 29, 2019, there have been 1,888 cases of lung injury due to e-cigarette use, or vaping, reported to the CDC from 49 states [(1)](https://www.cdc.gov/tobacco/basic_information/e-cigarettes/severe-lung-disease.html). Medical officials have become increasingly interested in the development of lung disease among users; however, there is still little known about the deleterious effects of e-cigarette use. While e-cigarettes and vapes were initially intended for current smokers to reduce tobacco dependency, these products have been massively marketed to teenagers with no smoking history. The goal of this project is to elucidate trends in e-cigarette use among youth in order to inform the development and implementation of preventive and therapeutic interventions.

## Related Work
The linkage between e-cigarette use and lung injury has gradually become more evident through scientific research [(2)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6776378/) [(3)](https://onlinelibrary.wiley.com/doi/full/10.1002/rcr2.282). Therefore, many have started to criticize suppliers, particularly because of their marketing towards teenagers. Companies such as JUUL have been accused of targeting younger individuals through introducing fruity flavors and running social media campaigns. Many have studied this phenomenon through the surveys to better understand patterns of use among young users and their interest in e-cigarettes. A recent study assessed responses from a nationally representative survey of participants ages 15-21 in 2018 and found that younger age, race, higher socioeconomic status, and perception that e-cigarettes are less harmful than standard cigarettes were all correlated with a higher risk of using e-cigarettes [(4)](https://tobaccocontrol.bmj.com/content/28/6/603.abstract?casa_token=1PALiqs1TR0AAAAA:bwza2kpvUrDvqaHwd1Eb9lVT3WoYpW3Um5QgUNo_m1bOCA7Vk3KW_-4X7jWT8M-izEn2AxPJ8ekh). A similar study conducted an online survey and found that in 2017, one fourth of youth and young adults recognized a JUUL device, and identified a lack of awareness regarding the potential harms of using electronic cigarettes [(5)](https://tobaccocontrol.bmj.com/content/28/1/115.abstract?casa_token=jha9u61gODYAAAAA:zNkcmBbrIMpDW7jAoCGVb3L97MvluMMSOPN8tddPrPoZK91Nnrb-YdZ-tCqWm_88YbtKIB1rUifT). However, these studies were not able to analyze e-cigarette use across time.

## Initial Questions

1. How has e-cigarette use among youth changed from 2011-2018?    

We wish to visualize patterns in e-cigarette use over time. While we know from outside sources that e-cigarettes have become very popular over the past few years, we hope to demonstrate this trend through visualizations to gain insights into when and to what degree e-cigarette use has changed from 2011-2018.

2. What factors put an individual at greatest risk of e-cigarette use?  

We will consider several demographics such as age, sex and race, as well as cigarette consumption, perception towards the harm of e-cigarettes, and the frequency of e-cigarette ads viewed.

3. How has legislation changed over time to address the growing rate of e-cigarette use throughout the United States?  

To build on previous studies, we want to consider the geographic component of e-cigarette use and attempts to reduce youth access to e-cigarettes.

## Data
Our analysis was conducted using three data sources. The fist dataset is the National Youth Tobacco Survey administered by CDC [(6)](https://www.cdc.gov/tobacco/data_statistics/surveys/nyts/data/index.html). We used survey data from 2011-2018. The surveys were completed by 8-19 year olds from across the United States to address trends in tobacco and e-cigarette use. To tidy the data, we extracted questions from the survey that pertained to e-cigarette use that were consistent throughout our study period. Since e-cigarette questions were not introduced until 2011, we restricted our analysis to 2011-2018. Some questions of interest were not included in all years. To account for this, we assigned missing values (`NA`) to observations in the years for which the question was not asked. The resulting dataset, `ecig_data`, contains `r nrow(ecig_data)` observations and `r ncol(ecig_data)` variables:

* `cig_days`: *"How many cigarettes have you smoked in the past 30 days?"*   
              levels: 0, 1-2, 3-5, 6-9, 10-19, 20-29, 30
* `try_ecigs`: *"Have you ever tried electronic cigarettes?"*   
              levels: yes, no
* `current_ecigs`: *"Have you used electronic cigarettes in the last 30 days?"*   
              levels: yes, no
* `quit_cig`: *"Are you trying to quit cigarettes?"*   
              levels: not a smoker, within the next 30 days, within the next 6 months, within 1 year, in over a year, no
* `heard_ecigs`: *"Have you heard of electronic cigarettes?"* (years 2012-2013)  
              levels: yes, no
* `harm_ecigs`: *"In your opinon, how harmful are electronic cigarettes compared to regular cigarettes?"* (years 2012-2018)  
              levels: less harmful, equally harmful, more harmful, never heard of e-cigarettes, unknown
* `age_first_ecig`: *"What age were you when you used an electronic cigarette for the first time?"* (years 2014-2018)     
              levels: never, 8 or younger, 9-18
* `reasons_ecigs`: *"Are you using electronic cigarettes to quit smoking?"* (years 2015-2018)   
              levels: yes, no
* `ads_ecigs` : *"When using the internet, how often do you see advertisements for electronic cigarettes?"*  
              levels: always, most of the time, sometimes, rarely, never, do not use the Internet  
* `weight` : a weight value assigned to each survey respondent to account for different representations among demographic groups  
* `year` : 2011-2018
* `sex` :  
              levels: male, female
* `race` :  
              levels: white, black, hispanic, asian, american indian / alaska native, native hawaiian / other pacific islander

Missingness varies over years and variables. In our analyses, we use only complete cases.
```{r results='asis'}
#NA Table
ecig_data %>%
  group_by(year) %>%
  summarise(cig_days = ifelse(mean(is.na(cig_days)) == 1, NA, mean(is.na(cig_days))),
            try_ecigs = mean(is.na(try_ecigs)),
            current_ecigs = mean(is.na(current_ecigs)),
            quit_cig = mean(is.na(quit_cig)),
            heard_ecigs = ifelse(mean(is.na(heard_ecigs)) == 1, NA, mean(is.na(heard_ecigs))),
            harm_ecigs = ifelse(mean(is.na(harm_ecigs)) == 1, NA, mean(is.na(harm_ecigs))),
            age_first_ecig = ifelse(mean(is.na(age_first_ecig)) == 1, NA, mean(is.na(age_first_ecig))),
            reasons_ecigs = ifelse(mean(is.na(reasons_ecigs)) == 1, NA, mean(is.na(reasons_ecigs))),
            ads_ecigs = ifelse(mean(is.na(ads_ecigs)) == 1, NA, mean(is.na(ads_ecigs))),
            sex = mean(is.na(sex)),
            race = mean(is.na(race))
            ) %>%
  knitr::kable(digits = 2, caption = "Percent of missingness in each variable per year")
```

Additionally, we question the representation of the sample for 9 and 10 year olds, since over half of the 9 year olds and over a quarter of the 10 year olds who completed the survey reported that they are cigarette smokers. This is clearly not representative of the population, so these ages were excluded in some analyses.
```{r results='asis'}
#HALF OF 10 YEAR OLDS ARE SMOKER 
ecig_data %>%
  filter(is.na(age) == F) %>%
  mutate(current_cig = as.numeric(cig_days != "0"),
         current_ecigs = as.numeric(current_ecigs == "yes") )%>%
  group_by(age) %>%
  summarise("Proportion Cig Smokers" = weighted.mean(current_cig, as.numeric(weight), na.rm = TRUE),
            "Proportion E-cig Smokers" = weighted.mean(current_ecigs, as.numeric(weight), na.rm = TRUE)) %>%
  knitr::kable(digits = 2)
```

The second data source is the CDC's State Tobacco Activities Tracking and Evaluation System [(7)](https://catalog.data.gov/dataset/cdc-state-system-e-cigarette-legislation-youth-access-a2edb). This data contains information on electronic cigarette legislation across the United States from 2011 to 2018. The resulting data set, `legislation_data` has `r nrow(legislation_data)` observations and `r ncol(legislation_data)` variables including:

* `year` : 2011-2018
* `location_abbr` : state abbreviation
* `location_desc` : state name
* `effective_date` : date on which the legislation became effective
* `geo_location` : geographic coordinates where legislation was enacted

Lastly, we will briefly refer to the CDC's State-Specific Patterns of E-Cigarette Use from 2016 [(8)](https://www.cdc.gov/pcd/issues/2019/18_0362.htm). This data provides the current prevalence of adult e-cigarette users within each state. The data has `r nrow(state_prev)` rows, denoting each state and the District of Columbia, and `r ncol(state_prev)` variables, denoting state names and their respective total, male, and female prevalences of e-cigarette use in 2016. 

## Exploratory Analysis
To address our first question, we created line plots to visualize how frequency of e-cigarette and standard cigarette use among youth have changed from 2011-2018. 

```{r}
ecig_data %>% 
  select(year, weight, ecigs_past_month, cig_days) %>% 
  mutate(
    ecigs_past_month = recode(ecigs_past_month, 
                                     "*" = "NA",
                                     "0" = "0",
                                     "1-2" = "1.5",
                                     "3-5" = "4", 
                                     "6-9" = "7.5", 
                                     "10-19" = "14.5", 
                                     "20-29" = "24.5", 
                                     "30" = "30"),
    cig_days = recode(cig_days, 
                                     "*" = "NA",
                                     "0" = "0",
                                     "1-2" = "1.5",
                                     "3-5" = "4", 
                                     "6-9" = "7.5", 
                                     "10-19" = "14.5", 
                                     "20-29" = "24.5", 
                                     "30" = "30")
  ) %>% 
  group_by(year) %>% 
  summarize(
    cig_days = weighted.mean(as.numeric(cig_days), as.numeric(weight), na.rm = TRUE), 
    ecig_days = weighted.mean(as.numeric(ecigs_past_month), as.numeric(weight), na.rm = TRUE)
  ) %>%
  pivot_longer(cig_days:ecig_days, values_to = "mean_days", names_to = "type") %>% 
  filter(mean_days!="NaN") %>% 
  ggplot(aes(x = year, y = mean_days)) + 
  geom_line(aes(group = type, color = type)) + 
  geom_point(aes(color = type)) + 
  scale_color_manual(
    values = c("#440154FF", "#20A387FF"),
    name = "",
    breaks=c("cig_days", "ecig_days"),
    labels=c("Cigarettes", "E-Cigs")
    ) +
  labs(title = "Average Days per Month Smoking", y = "Days Smoking", x = "Year") 
  
```

Overall, we can see that average monthly cigarette use has decreased from 2011-2018. Data on average monthly e-cigarette use is only available from 2015-2018; however, we can observe that e-cigarette use was more frequent than standard cigarette use from 2015-2018. E-cigarette use spiked from 2017-2018, but there does not seem to be evidence of a relationship between e-cigarette and standard cigarette use from this figure.

In addition to exploring e-cigarette use among youth over time, we created a map to consider prevalence of e-cigarette use among adults in 2016. Prevalence data is not publicly available for youth. Although this is adult data and different trends are likely to be observed between e-cigarette use among adults and youth, this data helps us to visualize e-cigarette use nationwide and to identify states with potentially high rates of e-cigarette sales.

INSERT PREVALENCE MAP HERE!!!

From this map, we can see that South Dakota


````````````````````````````````

Does viewing internet ads affect electronic cigarette use?
```{r results='asis'}
ecig_data %>% 
  mutate(
    ecigs_past_month = recode(ecigs_past_month, 
                                     "*" = "NA",
                                     "0" = "0",
                                     "1-2" = "1.5",
                                     "3-5" = "4", 
                                     "6-9" = "7.5", 
                                     "10-19" = "14.5", 
                                     "20-29" = "24.5", 
                                     "30" = "30"),
    ecigs_past_month = as.numeric(ecigs_past_month), 
    ads_ecigs = replace(ads_ecigs, ads_ecigs == "do no use the internet", "do not use the internet"), 
    ads_ecigs = fct_relevel(ads_ecigs, c("never", "rarely", "sometimes", "most of the time", "always", "do not use the internet"))
  ) %>% 
  
  select(ecigs_past_month, ads_ecigs, weight) %>% 
  drop_na() %>% 
  filter(ads_ecigs != "do not use the internet") %>% 
  group_by(ads_ecigs) %>% 
  summarize('Avg Days of E-Cig Use' = round(weighted.mean(ecigs_past_month, as.numeric(weight)), digits = 3)) %>% 
  rename("Viewing Rate of Internet E-Cig Ads" = ads_ecigs) %>%
  knitr::kable(digits = 2)
```

Does electronic cigarette use differ across year and sex?
```{r}
ecig_data %>%
  filter(is.na(try_ecigs) == FALSE, is.na(sex) == FALSE) %>%
  group_by(year, sex) %>%
  mutate(indc = ifelse(try_ecigs == "yes", 1, 0)) %>%
  summarise(y = weighted.mean(indc, as.numeric(weight))) %>%
  ggplot(aes(x = year, y = y, fill = sex)) +
  geom_col(position = "dodge") +
  #geom_text(aes(label=len), vjust=1.6, color="white", size=3.5) +
  ylab("Proportion Tried E-cigarettes") +
  xlab("Year") 
```


Does electronic cigarette use differ across age and sex?
```{r}
ecig_data %>%
  filter(is.na(age) == FALSE, is.na(sex) == FALSE, is.na(try_ecigs) == FALSE) %>%
  group_by(age, sex) %>%
  mutate(indc = ifelse(try_ecigs == "yes", 1, 0)) %>%
  summarise(y = weighted.mean(indc, as.numeric(weight))) %>%
  ggplot(aes(x = age, y = y, fill = sex)) +
  geom_col(position = "dodge") +
  xlab("Age") +
  ylab("Proportion Tried E-cigarettes") 
```


Has the perception of harmfulness of electronic cigarettes compared to cigarettes changed over time?
```{r}
#creating survey object 
srv_ecig = ecig_data %>% 
  mutate(id = row_number()) %>% 
   as_survey_design(id = id, wt = as.numeric(weight) )

#plot of harmful vs year 
srv_ecig %>% 
  filter( !is.na(quit_cig) , quit_cig != "not a smoker" ) %>% 
  filter( !is.na(harm_ecigs) ) %>%
  mutate(harm_ecigs = recode(harm_ecigs, "equally addictive" = "equally", "less addictive" = "less", "more addictive" = "more"), 
         ecigs_past_month = factor(ecigs_past_month, c(NA, "0", "1-2", "3-5", "6-9", "10-19", "20-29", "30"))
         ) %>% 
  filter( harm_ecigs =="less"| harm_ecigs =="equally" | harm_ecigs =="more") %>%
  filter( year != "2013", year != "2015") %>% 
  mutate(harm_ecigs = fct_relevel(harm_ecigs, c("less", "equally", "more"))) %>% 
  group_by(year, harm_ecigs) %>% 
  summarize(n = survey_total()) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes( x = year, y = prop, fill = harm_ecigs)) + 
  geom_bar(position ="dodge", stat ="identity") +
  labs(
    title = "Perception of Harmfulness of E-Cigarettes Compared to Cigarettes",
    x = "Year",
    y = "Proportion of Belief") +
  theme(plot.title = element_text(hjust = 0.5))
```


Are cigarette smokers more likely to try electronic cigarettes?
```{r}
#smokers are more likley to try ecigs
ecig_data %>%
  filter(is.na(age) == FALSE, is.na(try_ecigs) == FALSE, is.na(cig_days) == FALSE) %>%
  mutate(current_cig = as.numeric(cig_days != "0")) %>%
  mutate(current_cig = factor(current_cig, levels = c(0,1), labels = c("non-smoker", "smoker"))) %>%
  group_by(age, current_cig) %>%
  mutate(indc = ifelse(try_ecigs == "yes", 1, 0)) %>%
  summarise(y = weighted.mean(indc, as.numeric(weight))) %>%
  ggplot(aes(x = as.numeric(age), y = y, color = current_cig)) +
  geom_point() +
  geom_line() +
  xlab("Age") +
  ylab("Proportion Tried E-cigarettes") +
  labs(color = "Smoking Status") +
  scale_color_manual(values = c("#440154FF", "#20A387FF"))
```

Which races use e-cigs the most? 
```{r}
ecig_data %>% 
  mutate(
    ecigs_past_month = recode(ecigs_past_month, 
                                     "0" = "0",
                                     "1-2" = "1.5",
                                     "3-5" = "4", 
                                     "6-9" = "7.5", 
                                     "10-19" = "14.5", 
                                     "20-29" = "24.5", 
                                     "30" = "30"),
    ecigs_past_month = as.numeric(ecigs_past_month), 
  ) %>% 
  select(ecigs_past_month, race, weight) %>% 
  mutate(race = fct_relevel(race, c("native hawaiian / other pacific islander", "american indian / alaska native", "white", "hispanic", "black", "asian"))) %>% 
  drop_na() %>% 
  group_by(race) %>% 
  summarize(ecig_use = round(weighted.mean(ecigs_past_month, as.numeric(weight)), digits = 3))  %>% 
  arrange(ecig_use) %>% 
  ggplot(aes(x = race, y = ecig_use, fill = race)) + 
  geom_bar(stat = "identity") + 
  coord_flip() + 
  scale_x_discrete(name= "", labels = c("Native Hawaiian", "American Indian", "White", "Hispanic", "Black", "Asian")) + 
  labs(y = "Monthly E-Cig Use", title = "E-Cig Use across Races") + 
  theme(legend.position = "none")

```

## Additional Analysis

Finally, we built a logistic regression model to make inferences regarding current e-cigarette use.

```{r results='asis', message=FALSE}
ecig_data_for_regression = 
  read.csv("./ecig_dat.csv") %>%
  mutate(age = as.numeric(age),
         year = as.numeric(year),
         weight = as.numeric(weight),
         sex = factor(sex),
         race = factor(race),
         cig_days = factor(cig_days),
         try_ecigs = factor(try_ecigs),
         quit_cig = factor(quit_cig),
         harm_ecigs = factor(harm_ecigs),
         ads_ecigs = factor(ads_ecigs),
         current_ecigs = factor(current_ecigs)) %>%
  filter(!age %in% c("9", "10", "19"),
         year >= 2014,
         is.na(current_ecigs) != TRUE) %>%
  mutate(id = row_number())


full_log_model = glm(current_ecigs ~ age + year + sex + 
                       relevel(race, ref = "white") +
                       cig_days + 
                       relevel(harm_ecigs, ref = "never heard of e-cigs") + 
                       relevel(ads_ecigs, ref = "never"),
                     family = binomial,
                     data = ecig_data_for_regression)

#Table of beta estimates, SE, ORs, CIs, and p-values
log_model_summary = 
  tibble(
  "Variable" = c("intercept", "age", "year", "sex (male)", "race (Indian/Native)", "race (Asian)", "race (Black)", 
               "race (Hispanic)", "race (Haiwaiian/Pacific)", "cig_days (1-2)", "cig_days (10-19)",
               "cig_days (20-29)", "cig_days (3-5)", "cig_days (30)", "cig_days (6-9)", 
               "harm_ecigs (equally harmful)", "harm_ecigs (less harmful)", "harm_ecigs (more harmful)",
               "harm_ecigs (unknown)", "ads_ecigs (always)", "ads_ecigs (do not use Internet)",
               "ads_ecigs (most of the time)", "ads_ecigs (rarely)", "ads_ecigs (sometimes)"),
  "Estimate" = round(summary(full_log_model)$coefficients[, 1], digits = 2),
  "SE" = round(summary(full_log_model)$coefficients[, 2], digits = 2),
  "OR" = round(exp(coef(full_log_model)), digits = 2),
  "OR CI (2.5%)" = round(exp(confint(full_log_model))[, 1], digits = 2),
  "OR CI (97.5%)" = round(exp(confint(full_log_model))[, 2], digits = 2),
  "P-value" = round(summary(full_log_model)$coefficients[, 4], digits = 2))
  
log_model_summary %>% knitr::kable()

##OR plot
ggplot(log_model_summary, aes(x = Variable, y = OR)) +
  geom_pointrange(ymin = log_model_summary$`OR CI (2.5%)`, ymax = log_model_summary$`OR CI (97.5%)`) +
  geom_hline(aes(yintercept = 1), linetype = "dashed") +
  ylim(c(0, 17)) +
  coord_flip() +
  labs(title = "95% OR CIs")
```


## Discussion